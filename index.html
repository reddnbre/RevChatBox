<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RevChattyBox - Gaming Chat Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="revchattybox-modern.css">
</head>
<body class="rev-skin">
  <!-- Cookie Consent Banner -->
  <div id="cookieBanner" class="cookie-banner">
    <div class="cookie-content">
      <div class="cookie-text">
        <p>🍪 We use cookies to save your preferences and chat history. By continuing, you agree to our use of cookies.</p>
      </div>
      <div class="cookie-actions">
        <button id="cookieAccept" class="btn btn-primary">Accept</button>
        <button id="cookieDecline" class="btn btn-secondary">Decline</button>
      </div>
    </div>
  </div>

  <!-- Splash Screen -->
  <div id="splash" class="splash">
    <div class="splash-bg">
      <div class="blob"></div>
      <div class="blob"></div>
      <div class="blob"></div>
    </div>
    <div class="splash-card">
      <div class="splash-header">
        <div class="logo">🎮 RevChattyBox</div>
        <p class="tagline">Your Ultimate Gaming Chat Hub</p>
      </div>
      
      <div class="progress-section">
        <div class="progress-track">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-info">
          <span class="status-text" id="statusText">Initializing...</span>
          <span class="progress-percent" id="progressPercent">0%</span>
        </div>
      </div>
      
      <div class="progress-tips" id="progressTips">
        <div class="tip">🎯 Loading gaming features...</div>
        <div class="tip">🎨 Applying premium themes...</div>
        <div class="tip">🔧 Setting up chat system...</div>
        <div class="tip">🎮 Preparing game hub...</div>
        <div class="tip">⚡ Optimizing performance...</div>
        <div class="tip">🚀 Almost ready...</div>
        <div class="tip">✨ Welcome to RevChattyBox!</div>
      </div>
      
      <div class="splash-actions">
        <button id="enterBtn" class="btn btn-primary">Enter App</button>
        <button id="skipBtn" class="btn btn-secondary">Skip Loading</button>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="app" class="app" style="display: none;">
    <!-- Top Ad Banner -->
    <header class="header">
      <div class="ad-banner top-ad ad-top">
        <div class="ad-placeholder">Ad Space - Top Banner</div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Left Sidebar with Ad -->
      <aside class="sidebar left-sidebar ad-side">
        <div class="ad-banner side-ad ad-left">
          <div class="ad-placeholder">Ad Space - Left Sidebar</div>
        </div>
      </aside>

      <!-- Main Chat Area -->
      <main class="main-content">
        <div class="chat-container">
          <div class="chat-header">
            <h1>🎮 RevChattyBox</h1>
            <div class="header-actions">
              <span id="displayName" class="display-name"></span>
              <span id="userCount" class="pill users"><span class="dot"></span><span id="status">offline</span></span>
              <button id="gameHubBtn" class="btn">Game Hub</button>
              <button id="themeToggleBtn" class="btn" aria-label="Toggle theme">🌙</button>
              <button id="pmBtn" class="btn ghost" aria-label="Private Message">PM</button>
            </div>
          </div>
          
          <div class="chat-messages" id="chatMessages">
            <div class="system-message">
              Welcome to RevChattyBox! Your gaming chat hub.
            </div>
          </div>
          
          <div class="composer-bar">
            <div class="composer ibox">
              <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
              <button id="emojiBtn" class="btn btn-emoji" title="Add Emoji">😊</button>
              <button id="sendBtn" class="btn btn-primary send">Send</button>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar with Ad -->
      <aside class="sidebar right-sidebar ad-side">
        <div class="ad-banner side-ad ad-right">
          <div class="ad-placeholder">Ad Space - Right Sidebar</div>
        </div>
      </aside>
    </div>

    <!-- Bottom Ad Banner -->
    <footer class="footer">
      <div class="ad-banner bottom-ad ad-bottom">
        <div class="ad-placeholder">Ad Space - Bottom Banner</div>
      </div>
    </footer>
  </div>

  <!-- Name Entry Modal -->
  <div id="nameEntryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Welcome to RevChattyBox!</h2>
      </div>
      <div class="modal-body">
        <form id="nameEntryForm">
          <div class="form-group">
            <label for="displayNameInput">Enter your display name:</label>
            <input type="text" id="displayNameInput" placeholder="Your name..." maxlength="20" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Continue</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Game Hub Modal -->
  <div id="gameHubModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>🎮 Game Hub</h2>
        <span class="close" onclick="GameManager.hideGameHub()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="gameList" class="game-list">
          <!-- Games will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Game Modal -->
  <div id="gameModal" class="modal">
    <div class="modal-content game-modal">
      <div class="modal-header">
        <h2 id="gameTitle">Game</h2>
        <span class="close" onclick="GameManager.hideGameModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="gameStatus" class="game-status">
          <!-- Game status will be shown here -->
        </div>
        <div id="gameContainer" class="game-container">
          <!-- Game content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Emoji Picker Modal -->
  <div id="emojiPicker" class="emoji-picker">
    <div class="emoji-picker-content">
      <div class="emoji-picker-header">
        <h3>Choose an Emoji</h3>
        <span class="close" onclick="EmojiManager.hidePicker()">&times;</span>
      </div>
      <div class="emoji-grid">
        <!-- Emojis will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Firebase Real-time Chat System -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, orderBy, query, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // 🔥 REPLACE THIS WITH YOUR REAL FIREBASE CONFIG
    // Get this from: Firebase Console → Project Settings → Your Apps → Web App
    const firebaseConfig = {
      apiKey: "REPLACE_WITH_YOUR_API_KEY",
      authDomain: "your-project-id.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "your-sender-id",
      appId: "your-app-id"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Chat room setup
    const msgCol = collection(db, "messages");
    const msgQuery = query(msgCol, orderBy("timestamp", "asc"), limit(100));

    // UI elements
    const $messages = document.getElementById("chatMessages");
    const $input = document.getElementById("messageInput");
    const $name = document.getElementById("displayNameInput");
    const $status = document.getElementById("status");
    const $sendBtn = document.getElementById("sendBtn");

    // Name persistence
    $name.value = localStorage.getItem("revchat_name") || "";

    // Test Firebase connection
    console.log("🔥 Testing Firebase connection...");
    
    // Quick write test
    try {
      const testRef = await addDoc(collection(db, "test"), { 
        message: "Firebase test", 
        timestamp: serverTimestamp() 
      });
      console.log("✅ Firebase connected successfully!");
      $status.textContent = "online";
    } catch (error) {
      console.error("❌ Firebase connection failed:", error);
      $status.textContent = "offline";
      $status.style.color = "red";
      
      // Show setup instructions
      const setupDiv = document.createElement("div");
      setupDiv.innerHTML = `
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px; border-radius: 8px;">
          <h3>🔥 Firebase Setup Required</h3>
          <p>To enable real-time chat, you need to:</p>
          <ol>
            <li>Go to <a href="https://firebase.google.com" target="_blank">Firebase Console</a></li>
            <li>Create a new project</li>
            <li>Enable Firestore Database</li>
            <li>Add a web app and copy the config</li>
            <li>Replace the firebaseConfig in this file</li>
          </ol>
          <p><strong>Need help?</strong> Open <a href="firebase-setup.html" target="_blank">firebase-setup.html</a> for detailed instructions.</p>
        </div>
      `;
      $messages.appendChild(setupDiv);
    }

    // Live message stream
    onSnapshot(msgQuery, (snap) => {
      $status.textContent = "online";
      $status.style.color = "green";
      
      // Keep system message, clear others
      const systemMsg = $messages.querySelector('.system-message');
      $messages.innerHTML = "";
      if (systemMsg) $messages.appendChild(systemMsg);
      
      snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        const mine = (d.name || "") === (localStorage.getItem("revchat_name") || "");
        div.className = `message ${mine ? "user" : "other"}`;
        
        const header = document.createElement("div");
        header.className = "message-header";
        
        const senderName = document.createElement("span");
        senderName.className = "sender-name";
        senderName.textContent = d.name || "Anonymous";
        
        const time = document.createElement("span");
        time.className = "message-time";
        const when = d.timestamp?.toDate ? d.timestamp.toDate() : new Date();
        time.textContent = when.toLocaleTimeString();
        
        header.appendChild(senderName);
        header.appendChild(time);
        
        const content = document.createElement("div");
        content.className = "message-content";
        content.textContent = d.text || "";
        
        div.appendChild(header);
        div.appendChild(content);
        $messages.appendChild(div);
        $messages.scrollTop = $messages.scrollHeight;
      });
    }, (err) => {
      $status.textContent = "offline";
      $status.style.color = "red";
      console.error("Firebase error:", err);
    });

    // Send message
    $sendBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      await sendMessage();
    });

    // Enter key support
    $input.addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        await sendMessage();
      }
    });

    // Name change
    $name.addEventListener("change", () => {
      localStorage.setItem("revchat_name", $name.value.trim());
    });

    async function sendMessage() {
      const text = $input.value.trim();
      if (!text) return;

      const name = ($name.value || "Anonymous").slice(0, 24);
      
      try {
        await addDoc(msgCol, { 
          name, 
          text, 
          timestamp: serverTimestamp() 
        });
        $input.value = "";
      } catch (error) {
        console.error("Error sending message:", error);
        // Fallback: show message locally
        const div = document.createElement("div");
        div.className = "message user";
        div.innerHTML = `
          <div class="message-header">
            <span class="sender-name">${name}</span>
            <span class="message-time">${new Date().toLocaleTimeString()}</span>
          </div>
          <div class="message-content">${text} (sent locally - Firebase offline)</div>
        `;
        $messages.appendChild(div);
        $messages.scrollTop = $messages.scrollHeight;
        $input.value = "";
      }
    }
  </script>

  <!-- Load the rest of the app -->
  <script src="script.js"></script>
</body>
</html>