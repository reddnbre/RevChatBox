<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RevChattyBox - Gaming Chat Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="revchattybox-modern.css">
</head>
<body class="rev-skin">
  <!-- Cookie Consent Banner -->
  <div id="cookieBanner" class="cookie-banner">
    <div class="cookie-content">
      <div class="cookie-text">
        <p>🍪 We use cookies to save your preferences and chat history. By continuing, you agree to our use of cookies.</p>
      </div>
      <div class="cookie-actions">
        <button id="cookieAccept" class="btn btn-primary">Accept</button>
        <button id="cookieDecline" class="btn btn-secondary">Decline</button>
      </div>
    </div>
  </div>

  <!-- Splash Screen -->
  <div id="splash" class="splash">
    <div class="splash-bg">
      <div class="blob"></div>
      <div class="blob"></div>
      <div class="blob"></div>
    </div>
    <div class="splash-card">
      <div class="splash-header">
        <div class="logo">🎮 RevChattyBox</div>
        <p class="tagline">Your Ultimate Gaming Chat Hub</p>
      </div>
      
      <div class="progress-section">
        <div class="progress-track">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-info">
          <span class="status-text" id="statusText">Initializing...</span>
          <span class="progress-percent" id="progressPercent">0%</span>
        </div>
      </div>
      
      <div class="progress-tips" id="progressTips">
        <div class="tip">🎯 Loading gaming features...</div>
        <div class="tip">🎨 Applying premium themes...</div>
        <div class="tip">🔧 Setting up chat system...</div>
        <div class="tip">🎮 Preparing game hub...</div>
        <div class="tip">⚡ Optimizing performance...</div>
        <div class="tip">🚀 Almost ready...</div>
        <div class="tip">✨ Welcome to RevChattyBox!</div>
      </div>
      
      <div class="splash-actions">
        <button id="enterBtn" class="btn btn-primary">Enter App</button>
        <button id="skipBtn" class="btn btn-secondary">Skip Loading</button>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="app" class="app" style="display: none;">
    <!-- Top Ad Banner -->
    <header class="header">
      <div class="ad-banner top-ad ad-top">
        <div class="ad-placeholder">Ad Space - Top Banner</div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Left Sidebar with Ad -->
      <aside class="sidebar left-sidebar ad-side">
        <div class="ad-banner side-ad ad-left">
          <div class="ad-placeholder">Ad Space - Left Sidebar</div>
        </div>
      </aside>

      <!-- Main Chat Area -->
      <main class="main-content">
        <div class="chat-container">
          <div class="chat-header">
            <h1>🎮 RevChattyBox</h1>
            <div class="header-actions">
              <span id="displayName" class="display-name"></span>
              <span id="userCount" class="pill users"><span class="dot"></span><span id="status">offline</span></span>
              <button id="gameHubBtn" class="btn">Game Hub</button>
              <button id="themeToggleBtn" class="btn" aria-label="Toggle theme">🌙</button>
              <button id="pmBtn" class="btn ghost" aria-label="Private Message">PM</button>
            </div>
          </div>
          
          <div class="chat-messages" id="chatMessages">
            <div class="system-message">
              Welcome to RevChattyBox! Your gaming chat hub.
            </div>
          </div>
          
          <div class="composer-bar">
            <div class="composer ibox">
              <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
              <button id="emojiBtn" class="btn btn-emoji" title="Add Emoji">😊</button>
              <button id="sendBtn" class="btn btn-primary send">Send</button>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar with Ad -->
      <aside class="sidebar right-sidebar ad-side">
        <div class="ad-banner side-ad ad-right">
          <div class="ad-placeholder">Ad Space - Right Sidebar</div>
        </div>
      </aside>
    </div>

    <!-- Bottom Ad Banner -->
    <footer class="footer">
      <div class="ad-banner bottom-ad ad-bottom">
        <div class="ad-placeholder">Ad Space - Bottom Banner</div>
      </div>
    </footer>
  </div>

  <!-- Name Entry Modal -->
  <div id="nameEntryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Welcome to RevChattyBox!</h2>
      </div>
      <div class="modal-body">
        <form id="nameEntryForm">
          <div class="form-group">
            <label for="displayNameInput">Enter your display name:</label>
            <input type="text" id="displayNameInput" placeholder="Your name..." maxlength="20" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Continue</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Game Hub Modal -->
  <div id="gameHubModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>🎮 Game Hub</h2>
        <span class="close" onclick="GameManager.hideGameHub()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="gameList" class="game-list">
          <!-- Games will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Game Modal -->
  <div id="gameModal" class="modal">
    <div class="modal-content game-modal">
      <div class="modal-header">
        <h2 id="gameTitle">Game</h2>
        <span class="close" onclick="GameManager.hideGameModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="gameStatus" class="game-status">
          <!-- Game status will be shown here -->
        </div>
        <div id="gameContainer" class="game-container">
          <!-- Game content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Emoji Picker Modal -->
  <div id="emojiPicker" class="emoji-picker">
    <div class="emoji-picker-content">
      <div class="emoji-picker-header">
        <h3>Choose an Emoji</h3>
        <span class="close" onclick="EmojiManager.hidePicker()">&times;</span>
      </div>
      <div class="emoji-grid">
        <!-- Emojis will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Socket.IO Real-time Chat System -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Socket.IO Chat System
    class SocketChat {
      constructor() {
        this.socket = io();
        this.currentRoom = this.getRoomFromURL() || 'global';
        this.isConnected = false;
        this.init();
      }

      init() {
        console.log('🚀 Initializing Socket.IO chat...');
        this.setupElements();
        this.setupSocketEvents();
        this.setupEventListeners();
        this.joinRoom(this.currentRoom);
      }

      getRoomFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('room');
      }

      setupElements() {
        this.$messages = document.getElementById("chatMessages");
        this.$input = document.getElementById("messageInput");
        this.$name = document.getElementById("displayNameInput");
        this.$status = document.getElementById("status");
        this.$sendBtn = document.getElementById("sendBtn");

        // Name persistence
        this.$name.value = localStorage.getItem("revchat_name") || "";
      }

      setupSocketEvents() {
        // Connection events
        this.socket.on('connect', () => {
          console.log('✅ Connected to server');
          this.isConnected = true;
          this.updateStatus('online', 'green');
          this.joinRoom(this.currentRoom);
        });

        this.socket.on('disconnect', () => {
          console.log('❌ Disconnected from server');
          this.isConnected = false;
          this.updateStatus('offline', 'red');
        });

        // Chat events
        this.socket.on('history', (messages) => {
          this.displayHistory(messages);
        });

        this.socket.on('chat:message', (message) => {
          this.displayMessage(message);
        });

        this.socket.on('system', (message) => {
          this.displaySystemMessage(message);
        });

        this.socket.on('typing', (data) => {
          this.showTyping(data.name);
        });

        this.socket.on('user_count', (count) => {
          this.updateUserCount(count);
        });
      }

      setupEventListeners() {
        // Send button
        this.$sendBtn.addEventListener("click", (e) => {
          e.preventDefault();
          this.sendMessage();
        });

        // Enter key
        this.$input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // Typing indicator
        let typingTimer;
        this.$input.addEventListener("input", () => {
          if (this.isConnected) {
            this.socket.emit("typing");
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
              this.hideTyping();
            }, 1500);
          }
        });

        // Name change
        this.$name.addEventListener("change", () => {
          localStorage.setItem("revchat_name", this.$name.value.trim());
          if (this.isConnected) {
            this.joinRoom(this.currentRoom);
          }
        });
      }

      joinRoom(room) {
        if (!this.isConnected) return;
        
        const name = this.$name.value.trim() || "Anonymous";
        console.log(`Joining room: ${room} as ${name}`);
        this.socket.emit("join", { room, name });
        this.currentRoom = room;
      }

      sendMessage() {
        const text = this.$input.value.trim();
        if (!text || !this.isConnected) return;

        this.socket.emit("chat:message", { text });
        this.$input.value = "";
      }

      displayHistory(messages) {
        // Keep system message, clear others
        const systemMsg = this.$messages.querySelector('.system-message');
        this.$messages.innerHTML = "";
        if (systemMsg) this.$messages.appendChild(systemMsg);
        
        messages.forEach(message => {
          if (message.type === 'system') {
            this.displaySystemMessage(message);
          } else {
            this.displayMessage(message);
          }
        });
        
        this.$messages.scrollTop = this.$messages.scrollHeight;
      }

      displayMessage(message) {
        const div = document.createElement("div");
        const isMine = message.id === this.socket.id;
        div.className = `message ${isMine ? "user" : "other"}`;
        
        const header = document.createElement("div");
        header.className = "message-header";
        
        const senderName = document.createElement("span");
        senderName.className = "sender-name";
        senderName.textContent = message.name || "Anonymous";
        
        const time = document.createElement("span");
        time.className = "message-time";
        time.textContent = new Date(message.ts).toLocaleTimeString();
        
        header.appendChild(senderName);
        header.appendChild(time);
        
        const content = document.createElement("div");
        content.className = "message-content";
        content.textContent = message.text || "";
        
        div.appendChild(header);
        div.appendChild(content);
        
        // Keep system message at top
        const systemMsg = this.$messages.querySelector('.system-message');
        if (systemMsg && systemMsg.nextSibling) {
          this.$messages.insertBefore(div, systemMsg.nextSibling);
        } else {
          this.$messages.appendChild(div);
        }
        
        this.$messages.scrollTop = this.$messages.scrollHeight;
      }

      displaySystemMessage(message) {
        const div = document.createElement("div");
        div.className = "message system";
        
        const content = document.createElement("div");
        content.className = "message-content";
        content.textContent = message.text || "";
        
        div.appendChild(content);
        
        // Keep system message at top
        const systemMsg = this.$messages.querySelector('.system-message');
        if (systemMsg && systemMsg.nextSibling) {
          this.$messages.insertBefore(div, systemMsg.nextSibling);
        } else {
          this.$messages.appendChild(div);
        }
        
        this.$messages.scrollTop = this.$messages.scrollHeight;
      }

      showTyping(name) {
        // Simple typing indicator - you can enhance this
        console.log(`${name} is typing...`);
      }

      hideTyping() {
        // Hide typing indicator
      }

      updateStatus(status, color) {
        this.$status.textContent = status;
        this.$status.style.color = color || 'inherit';
      }

      updateUserCount(count) {
        const userCountElement = document.querySelector('.pill.users span:last-child');
        if (userCountElement) {
          userCountElement.textContent = `Users: ${count}`;
        }
      }
    }

    // Initialize chat when page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.socketChat = new SocketChat();
    });
  </script>

  <!-- Load the rest of the app -->
  <script src="script.js"></script>
</body>
</html>